@page "/panier_paiement"
@rendermode InteractiveServer
@using BD_ProjetBlazor.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.Security.Claims
@using BD_ProjetBlazor.Data
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Nav
@inject Requete_Achat_Reservation Service
@inject AuthenticationStateProvider Auth
@inject ProtectedSessionStorage SessionStorage
@inject IDbContextFactory<ProgA25BdProjetProgContext> DbFactory

<h3>Mes réservations</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isLoading)
{
    <p>Chargement...</p>
}
else
{
    <div class="mb-3">
        @if (isAdmin)
        {
            <span class="badge bg-warning text-dark">Admin — voit toutes les réservations</span>
            <div class="mt-2">
                <label>Filtrer par Utilisateur (ID):</label>
                <input class="form-control d-inline-block w-auto ms-2" @bind="filterUserIdString" placeholder="ex: 3" />
                <button class="btn btn-sm btn-secondary ms-2" @onclick="ApplyFilter">Appliquer</button>
                <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="ClearFilter">Effacer</button>
            </div>
        }
        else
        {
            <span class="badge bg-primary">Utilisateur</span>
        }
    </div>

    @if (reservations == null || !reservations.Any())
    {
        <p>Aucune réservation.</p>
    }
    else
    {
        <ul class="list-group mb-4">
            @foreach (var r in reservations)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <b>ID:</b> @r.EntreSortieStationnement —
                        @r.DateEntree.ToShortDateString() → @r.DateSortie.ToShortDateString()
                        (@r.PaiementSortie.ToString("C"))

                        @if (isAdmin)
                        {
                            <span class="ms-3"><b>UtilisateurId:</b> @r.NumUtilisateur</span>
                        }
                    </div>
                    <div>
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => LoadReservation(r.EntreSortieStationnement)">Voir</button>
                        @if (r.PaiementRecu == false)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteReservation(r.EntreSortieStationnement)">Supprimer</button>
                        }
                    </div>
                </li>
            }
        </ul>
    }
}

@if (reservation != null)
{
    <h3>Résumé</h3>
    <p><b>Stationnement :</b> @reservation.NumStationnement</p>
    <p><b>Entrée :</b> @reservation.DateEntree.ToShortDateString()</p>
    <p><b>Sortie :</b> @reservation.DateSortie.ToShortDateString()</p>
    <p><b>Total :</b> @reservation.PaiementSortie.ToString("C")</p>
    @if(reservation.PaiementRecu == false)
    {
    <button class="btn btn-primary" @onclick="ValiderPaiement">Payer</button>
    }

}

@code {
    List<StationnementEntreeSortie>? reservations;
    StationnementEntreeSortie? reservation;

    bool isAdmin = false;
    bool isLoading = true;

    int? filterUserId = null;
    string? filterUserIdString;

    int currentUserId = 0;
    string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;

            // 1) Role
            if (user?.Identity?.IsAuthenticated == true)
            {
                var roleClaim = user.FindFirst(c => c.Type == ClaimTypes.Role);
                isAdmin = roleClaim != null && string.Equals(roleClaim.Value, "admin", StringComparison.OrdinalIgnoreCase);
            }

            // 2) Try NameIdentifier claim first
            if (user?.Identity?.IsAuthenticated == true)
            {
                var idClaim = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
                if (idClaim != null && int.TryParse(idClaim.Value, out var idFromClaim))
                {
                    currentUserId = idFromClaim;
                }
            }

            // 3) Fallback: session storage (UserSession.utilisateurId)
            if (currentUserId == 0)
            {
                var session = await SessionStorage.GetAsync<UserSession>("UserSession");
                if (session.Success && session.Value != null)
                {
                    if (session.Value.utilisateurId > 0)
                        currentUserId = session.Value.utilisateurId;

                    // ensure we pick admin from session if not set by claim
                    if (!isAdmin && !string.IsNullOrEmpty(session.Value.role))
                        isAdmin = string.Equals(session.Value.role, "admin", StringComparison.OrdinalIgnoreCase);
                }
            }

            // 4) Last resort: try to resolve DB utilisateur by matching ClaimTypes.Name (email or name)
            if (currentUserId == 0 && user?.Identity?.IsAuthenticated == true)
            {
                var nameClaim = user.FindFirst(c => c.Type == ClaimTypes.Name)?.Value;
                if (!string.IsNullOrEmpty(nameClaim))
                {
                    try
                    {
                        await using var db = await DbFactory.CreateDbContextAsync();

                        // Attempt matching by email first, then by nom + prenom, then nom alone.
                        var utilisateur = await db.Utilisateurs
                            .Where(u => u.Email == nameClaim
                                        || (u.Nom + " " + u.Prenom) == nameClaim
                                        || u.Nom == nameClaim)
                            .OrderBy(u => u.NoUtilisateur)
                            .FirstOrDefaultAsync();

                        if (utilisateur != null)
                        {
                            currentUserId = utilisateur.NoUtilisateur;
                        }
                    }
                    catch (Exception exDb)
                    {
                        // Ne pas faire crasher la page — on conserve currentUserId = 0 et on affichera message plus bas.
                        Console.WriteLine("Erreur lecture utilisateur BD: " + exDb.Message);
                    }
                }
            }

            // If still 0 and not admin -> show message and stop
            if (currentUserId == 0 && !isAdmin)
            {
                errorMessage = "Impossible d'identifier l'utilisateur (ID). Veuillez vous reconnecter.";
                reservations = new List<StationnementEntreeSortie>();
                return;
            }

            await LoadReservations();
        }
        catch (Exception ex)
        {
            errorMessage = "Erreur lors du chargement : " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    async Task LoadReservations()
    {
        try
        {
            if (isAdmin)
            {
                var all = await Service.GetAllReservations();
                if (filterUserId.HasValue)
                    reservations = all.Where(r => r.NumUtilisateur == filterUserId.Value).ToList();
                else
                    reservations = all;
            }
            else
            {
                reservations = await Service.GetReservationsByUserId(currentUserId);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erreur lors du chargement des réservations : " + ex.Message;
            reservations = new List<StationnementEntreeSortie>();
        }
    }

    async Task ApplyFilter()
    {
        filterUserId = int.TryParse(filterUserIdString, out var id) ? id : null;
        await LoadReservations();
    }

    async Task ClearFilter()
    {
        filterUserId = null;
        filterUserIdString = null;
        await LoadReservations();
    }

    async Task LoadReservation(int id)
    {
        try
        {
            var r = await Service.GetReservationFromDb(id);
            reservation = r;
        }
        catch (Exception ex)
        {
            errorMessage = "Impossible de charger la réservation : " + ex.Message;
        }
    }

    async Task DeleteReservation(int id)
    {
        try
        {
            if (await Service.DeleteReservationAs(id, currentUserId, isAdmin))
            {
                await LoadReservations();
                reservation = null;
            }
            else
            {
                errorMessage = "Suppression non autorisée ou réservation introuvable.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erreur lors de la suppression : " + ex.Message;
        }
    }
    async Task ValiderPaiement()
    {
        if (reservation == null)
            return;

        var success = await Service.MarquerPaiementCommeRecu(reservation.EntreSortieStationnement);

        if (success)
        {
            // recharge les réservations pour mettre à jour l'affichage
            await LoadReservations();
            reservation = null;

            Nav.NavigateTo("/Info_Entree_Sortie");
        }
        else
        {
            errorMessage = "Erreur lors du paiement.";
        }
    }

    async Task CreateCheckout()
    {
        if (reservation == null) return;
        var url = await Service.CreateStripeCheckout(reservation.EntreSortieStationnement);
        Nav.NavigateTo("/Info_Entree_Sortie");
    }
}
