@page "/panier_paiement"
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Nav
@inject Requete_Achat_Reservation Service
@inject AuthenticationStateProvider Auth

<h3>Mes réservations</h3>

@if (reservations == null)
{
    <p>Chargement...</p>
}
else if (!reservations.Any())
{
    <p>Aucune réservation.</p>
}
else
{
    <ul class="list-group mb-4">
        @foreach (var r in reservations)
        {
            <li class="list-group-item d-flex justify-content-between">
                <span>
                    <b>ID:</b> @r.ReservationId —
                    @r.DateEntree.ToShortDateString() → @r.DateSortie.ToShortDateString()
                    (@r.Montant.ToString("C"))
                </span>

                <div>
                    <button class="btn btn-sm btn-secondary me-1"
                            @onclick="() => LoadReservation(r.ReservationId)">
                        Voir
                    </button>

                    <button class="btn btn-sm btn-danger"
                            @onclick="() => DeleteReservation(r.ReservationId)">
                        Supprimer
                    </button>
                </div>
            </li>
        }
    </ul>
}

@if (reservation != null)
{
    <h3>Résumé</h3>
    <p><b>Stationnement :</b> @reservation.NumStationnement</p>
    <p><b>Entrée :</b> @reservation.DateEntree.ToShortDateString()</p>
    <p><b>Sortie :</b> @reservation.DateSortie.ToShortDateString()</p>
    <p><b>Total :</b> @reservation.Montant.ToString("C")</p>

    <button class="btn btn-primary" @onclick="CreateCheckout">
        Payer
    </button>
}

@code {
    List<ReservationDTO>? reservations;
    ReservationDTO? reservation;

    protected override async Task OnInitializedAsync()
    {
        //reservations = await Service.GetReservationsForUser();
    }

    async Task LoadReservation(int id)
    {
        reservation = await Service.GetReservationFromDb(id);
    }

    async Task DeleteReservation(int id)
    {
        if (await Service.DeleteReservation(id))
        {
     //       reservations = await Service.GetReservationsForUser();
        }
    }

    async Task CreateCheckout()
    {
        if (reservation == null) return;

        var url = await Service.CreateStripeCheckout(reservation.ReservationId);
        Nav.NavigateTo(url, forceLoad: true);
    }
}
