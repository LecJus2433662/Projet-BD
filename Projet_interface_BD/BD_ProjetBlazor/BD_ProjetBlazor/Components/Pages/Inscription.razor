@page "/inscription"
@using System.Text
@using BD_ProjetBlazor.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@attribute [StreamRendering]
@rendermode InteractiveServer
@inject Requete_inscriptions Requete_inscription
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthProvider

<h3 class="text-center mb-4">Inscription</h3>

<div class="container border rounded p-4 bg-white" style="max-width: 600px;">
    <EditForm Model="@model" OnValidSubmit="HandleSubmit" FormName="inscription">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-3">
            <label class="form-label">Courriel :</label>
            <InputText type="email" class="form-control" @bind-Value="model.Email" />
        </div>

        <div class="mb-3">
            <label class="form-label">Mot de passe :</label>
            <InputText type="password" class="form-control" @bind-Value="model.MotDePasse" />
        </div>

        <div class="mb-3">
            <label class="form-label">Prénom :</label>
            <InputText class="form-control" @bind-Value="model.Prenom" />
        </div>

        <div class="mb-3">
            <label class="form-label">Nom :</label>
            <InputText class="form-control" @bind-Value="model.Nom" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ville :</label>
            <InputText class="form-control" @bind-Value="model.Ville" />
        </div>

        <div class="mb-3">
            <label class="form-label">Pays :</label>
            <InputText class="form-control" @bind-Value="model.Pays" />
        </div>

        <button type="submit" class="btn btn-primary w-100">S'inscrire</button>
        <button class="btn btn-primary w-100 mt-3" @onclick="NavigateToLogin">Connexion</button>
    </EditForm>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="alert @AlertClass mt-3">@Message</div>
    }
</div>

@code {
    private ModelInscription model = new();
    private string Message = "";
    private string AlertClass = "";

    private async Task HandleSubmit()
    {
        Message = "";
        AlertClass = "";

        try
        {
            var passwordBytes = Encoding.UTF8.GetBytes(model.MotDePasse);

            var result = await Requete_inscription.AjouterUtilisateur(
                model.Email,
                passwordBytes,
                model.Prenom,
                model.Nom,
                model.Ville,
                model.Pays
            );

           
            if (result > 0)
            {
                var userSession = new UserSession
                {
                    nomUtilisateur = model.Email,
                    role = "user"
                };

                var customAuth = (CustomAuthenticationStateProvider)AuthProvider;
                await customAuth.UpdateAuthenticationState(userSession);

                Message = "Inscription réussie ! Bienvenue !";
                AlertClass = "alert-success";

                NavigationManager.NavigateTo("/Info_Entree_Sortie");
            }
            else if (result == -2)
            {
                Message = "Ce courriel est déjà utilisé.";
                AlertClass = "alert-warning";
            }
            else
            {
                Message = "Erreur lors de l'inscription. Veuillez réessayer.";
                AlertClass = "alert-danger";
            }
        }
        catch (Exception)
        {
            Message = "Une erreur inattendue est survenue.";
            AlertClass = "alert-danger";
        }
    }
    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/");
    }
}
